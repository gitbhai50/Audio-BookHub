<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéß Audiobook Hub ¬∑ fully functional</title>
  <!-- Tailwind + Font Awesome + Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* smooth glass, animations, custom scrollbar */
    .view { transition: opacity 0.2s ease; }
    .glass-card { background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); }
    body { background: linear-gradient(145deg, #f1f5f9 0%, #e0eaf2 100%); min-height: 100vh; }
    .player-progress { height: 6px; background: #ddd; border-radius: 999px; }
    .player-progress-fill { height: 6px; background: #3b82f6; border-radius: 999px; width: 0%; }
    .tab-active { border-bottom: 3px solid #3b82f6; font-weight: 600; color: #1e3a8a; }
    .audio-card { transition: transform 0.1s ease; }
    .audio-card:hover { transform: scale(1.02); }
    /* custom scrollbar */
    ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #a0c4ff; border-radius: 8px; }
  </style>
</head>
<body class="font-sans antialiased">

  <!-- ========== MODERN GLASS NAVIGATION ========== -->
  <nav class="glass-card sticky top-0 z-20 px-6 py-3 shadow-sm flex flex-wrap items-center justify-between">
    <div class="flex items-center space-x-2 text-2xl font-bold text-blue-700">
      <i class="fas fa-headphones"></i>
      <span>Audiobook<span class="text-blue-500">Hub</span></span>
    </div>
    <div class="flex flex-wrap items-center gap-2 text-sm md:text-base" id="nav-links">
      <!-- dynamic JS -->
    </div>
  </nav>

  <!-- ========== MAIN VIEW CONTAINER ========== -->
  <main class="max-w-7xl mx-auto px-4 py-6">

    <!-- ############  HOME  ############ -->
    <section id="view-home" class="view">
      <div class="text-center mb-12">
        <h1 class="text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-700 to-teal-500 drop-shadow-lg">Listen, upload, share</h1>
        <p class="text-gray-600 text-xl mt-4 max-w-2xl mx-auto">A modern audiobook platform where your voice finds an audience.</p>
        <div class="mt-8 flex gap-4 justify-center flex-wrap">
          <button onclick="navigate('register')" class="bg-blue-600 text-white px-8 py-3 rounded-full text-lg font-medium shadow-lg hover:bg-blue-700 transition"><i class="fas fa-user-plus mr-2"></i>Get started</button>
          <button onclick="navigate('login')" class="bg-white text-blue-600 border border-blue-200 px-8 py-3 rounded-full text-lg font-medium shadow hover:shadow-md transition"><i class="fas fa-sign-in-alt mr-2"></i>Login</button>
        </div>
      </div>
      <div class="grid md:grid-cols-3 gap-6 text-center">
        <div class="glass-card p-8 rounded-2xl shadow-md"><i class="fas fa-cloud-upload-alt text-4xl text-blue-500 mb-4"></i><h3 class="text-xl font-semibold">Upload</h3><p class="text-gray-600 mt-2">Share audiobooks, set public/private.</p></div>
        <div class="glass-card p-8 rounded-2xl shadow-md"><i class="fas fa-play-circle text-4xl text-blue-500 mb-4"></i><h3 class="text-xl font-semibold">Stream</h3><p class="text-gray-600 mt-2">Built‚Äëin player with speed & seek.</p></div>
        <div class="glass-card p-8 rounded-2xl shadow-md"><i class="fas fa-download text-4xl text-blue-500 mb-4"></i><h3 class="text-xl font-semibold">Download</h3><p class="text-gray-600 mt-2">Save offline, listen anywhere.</p></div>
      </div>
      <div class="mt-16 text-center"><p class="text-lg text-gray-500">‚ú® fully functional demo ‚Äì all buttons work ‚ú®</p></div>
    </section>

    <!-- ############  LOGIN  ############ -->
    <section id="view-login" class="view hidden max-w-md mx-auto">
      <div class="glass-card p-8 rounded-2xl shadow-xl">
        <h2 class="text-3xl font-bold text-gray-800 mb-6"><i class="fas fa-lock mr-2 text-blue-500"></i>User login</h2>
        <form id="login-form" onsubmit="handleLogin(event)">
          <div class="mb-5"><label class="block text-gray-700 font-medium mb-2">Email</label><input type="email" id="login-email" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-300" placeholder="user@example.com" value="demo@user.com" required></div>
          <div class="mb-5"><label class="block text-gray-700 font-medium mb-2">Password</label><input type="password" id="login-password" class="w-full p-3 border border-gray-300 rounded-xl" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="123456" required></div>
          <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl text-lg font-semibold hover:bg-blue-700 transition"><i class="fas fa-arrow-right-to-bracket mr-2"></i>Sign in</button>
        </form>
        <p class="text-center mt-5 text-gray-600">No account? <button onclick="navigate('register')" class="text-blue-600 font-medium hover:underline">Register</button></p>
        <p class="text-center"><button onclick="navigate('forgot-password')" class="text-sm text-gray-500 hover:text-blue-600">Forgot password?</button></p>
        <hr class="my-4">
        <p class="text-center text-gray-500 text-sm">Admin? <button onclick="navigate('admin-login')" class="text-blue-600 hover:underline">Admin login</button></p>
      </div>
    </section>

    <!-- ############  REGISTER  ############ -->
    <section id="view-register" class="view hidden max-w-md mx-auto">
      <div class="glass-card p-8 rounded-2xl shadow-xl">
        <h2 class="text-3xl font-bold text-gray-800 mb-6"><i class="fas fa-user-plus mr-2 text-green-500"></i>Create account</h2>
        <form onsubmit="handleRegister(event)">
          <div class="mb-4"><label class="block font-medium mb-1">Username</label><input type="text" id="reg-username" class="w-full p-3 border rounded-xl" required></div>
          <div class="mb-4"><label class="block font-medium mb-1">Email</label><input type="email" id="reg-email" class="w-full p-3 border rounded-xl" required></div>
          <div class="mb-4"><label class="block font-medium mb-1">Password</label><input type="password" id="reg-password" class="w-full p-3 border rounded-xl" required></div>
          <div class="mb-4"><label class="block font-medium mb-1">Confirm</label><input type="password" id="reg-confirm" class="w-full p-3 border rounded-xl" required></div>
          <div class="mb-6 flex items-center"><input type="checkbox" id="terms" class="mr-2" required><label class="text-gray-600 text-sm">I agree to the <a href="#" class="text-blue-600">Terms</a></label></div>
          <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700"><i class="fas fa-check-circle mr-2"></i>Register</button>
        </form>
        <p class="text-center mt-4">Already a member? <button onclick="navigate('login')" class="text-blue-600 hover:underline">Login</button></p>
      </div>
    </section>

    <!-- ############  ADMIN LOGIN  ############ -->
    <section id="view-admin-login" class="view hidden max-w-md mx-auto">
      <div class="glass-card p-8 rounded-2xl shadow-xl border-t-4 border-purple-500">
        <h2 class="text-3xl font-bold text-gray-800 mb-2"><i class="fas fa-user-shield mr-2 text-purple-600"></i>Admin login</h2>
        <p class="text-gray-500 mb-6">2FA ready (mock)</p>
        <form onsubmit="handleAdminLogin(event)">
          <div class="mb-4"><label class="block font-medium">Email</label><input type="email" id="admin-email" class="w-full p-3 border rounded-xl" value="admin@demo.com" required></div>
          <div class="mb-4"><label class="block font-medium">Password</label><input type="password" id="admin-password" class="w-full p-3 border rounded-xl" value="admin123" required></div>
          <div class="mb-6"><label class="block font-medium">2FA code (mock)</label><input type="text" id="admin-2fa" class="w-full p-3 border rounded-xl" placeholder="000000"></div>
          <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-xl font-semibold hover:bg-purple-700"><i class="fas fa-lock mr-2"></i>Admin sign in</button>
        </form>
        <p class="text-center mt-5"><button onclick="navigate('admin-register')" class="text-purple-600 hover:underline">Request admin account</button></p>
      </div>
    </section>

    <!-- ############  ADMIN REGISTER  ############ -->
    <section id="view-admin-register" class="view hidden max-w-md mx-auto">
      <div class="glass-card p-8 rounded-2xl">
        <h2 class="text-2xl font-bold mb-4">Admin registration</h2>
        <form onsubmit="handleAdminRegister(event)">
          <div class="mb-3"><label class="block font-medium">Username</label><input type="text" id="admin-reg-user" class="w-full p-3 border rounded-xl" required></div>
          <div class="mb-3"><label class="block font-medium">Email</label><input type="email" id="admin-reg-email" class="w-full p-3 border rounded-xl" required></div>
          <div class="mb-3"><label class="block font-medium">Password</label><input type="password" id="admin-reg-pass" class="w-full p-3 border rounded-xl" required></div>
          <div class="mb-3"><label class="block font-medium">Admin secret</label><input type="text" id="admin-secret" class="w-full p-3 border rounded-xl" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required></div>
          <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-xl font-semibold">Register as admin</button>
        </form>
        <p class="text-center mt-3"><button onclick="navigate('admin-login')" class="text-purple-600">‚Üê back to admin login</button></p>
      </div>
    </section>

    <!-- ############  USER DASHBOARD  ############ -->
    <section id="view-dashboard" class="view hidden">
      <div class="mb-6 flex flex-wrap items-center justify-between gap-2">
        <h1 class="text-3xl font-bold"><i class="fas fa-tachometer-alt mr-3 text-blue-500"></i>My dashboard</h1>
        <span class="bg-blue-100 text-blue-800 px-4 py-1 rounded-full text-sm" id="dashboard-username"></span>
      </div>
      <!-- tabs -->
      <div class="flex gap-2 border-b mb-6 flex-wrap" id="dashboard-tabs-container">
        <button class="dashboard-tab px-4 py-2 text-gray-600" data-dtab="uploads">üì§ My uploads</button>
        <button class="dashboard-tab px-4 py-2 text-gray-600" data-dtab="history">üìú History</button>
        <button class="dashboard-tab px-4 py-2 text-gray-600" data-dtab="favorites">‚ù§Ô∏è Favorites</button>
        <button class="dashboard-tab px-4 py-2 text-gray-600" data-dtab="profile">üë§ Profile</button>
      </div>
      <!-- uploads tab -->
      <div id="dashboard-uploads" class="dashboard-tab-content">
        <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">Your audiobooks</h2><button onclick="navigate('upload')" class="bg-blue-500 text-white px-4 py-2 rounded-full text-sm"><i class="fas fa-plus mr-1"></i>Upload new</button></div>
        <div id="my-uploads-list" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>
      <!-- history -->
      <div id="dashboard-history" class="dashboard-tab-content hidden">
        <h2 class="text-xl font-semibold mb-3">Recent listens</h2>
        <ul id="history-list" class="space-y-2 text-gray-700"></ul>
      </div>
      <!-- favorites -->
      <div id="dashboard-favorites" class="dashboard-tab-content hidden">
        <h2 class="text-xl font-semibold mb-3">Your favorites</h2>
        <ul id="favorites-list" class="space-y-2"></ul>
      </div>
      <!-- profile -->
      <div id="dashboard-profile" class="dashboard-tab-content hidden max-w-md">
        <form onsubmit="updateProfile(event)">
          <div class="mb-3"><label class="block font-medium">Email</label><input type="email" id="profile-email" class="w-full p-2 border rounded"></div>
          <div class="mb-3"><label class="block font-medium">Username</label><input type="text" id="profile-username" class="w-full p-2 border rounded"></div>
          <button class="bg-blue-600 text-white px-4 py-2 rounded">Update profile</button>
        </form>
      </div>
    </section>

    <!-- ############  ADMIN DASHBOARD  ############ -->
    <section id="view-admin-dashboard" class="view hidden">
      <h1 class="text-3xl font-bold mb-6"><i class="fas fa-chart-line mr-3 text-purple-600"></i>Admin console</h1>
      <div class="grid grid-cols-3 gap-4 mb-8">
        <div class="glass-card p-4 rounded-2xl text-center"><span class="text-3xl font-bold text-purple-700" id="stats-users">0</span><p>Users</p></div>
        <div class="glass-card p-4 rounded-2xl text-center"><span class="text-3xl font-bold text-purple-700" id="stats-books">0</span><p>Audiobooks</p></div>
        <div class="glass-card p-4 rounded-2xl text-center"><span class="text-3xl font-bold text-purple-700" id="stats-listens">0</span><p>Listens</p></div>
      </div>
      <div class="flex gap-3 border-b mb-4 flex-wrap">
        <button class="admin-tab px-4 py-2" data-admin="users">üë• Users</button>
        <button class="admin-tab px-4 py-2" data-admin="audiobooks">üéß Audiobooks</button>
        <button class="admin-tab px-4 py-2" data-admin="analytics">üìä Analytics</button>
      </div>
      <div id="admin-users" class="admin-content">
        <table class="min-w-full bg-white/60 rounded-xl"><thead><tr><th>ID</th><th>Username</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead><tbody id="admin-users-list"></tbody></table>
      </div>
      <div id="admin-audiobooks" class="admin-content hidden">
        <table class="min-w-full bg-white/60 rounded-xl"><thead><tr><th>Title</th><th>Author</th><th>Uploader</th><th>Actions</th></tr></thead><tbody id="admin-books-list"></tbody></table>
      </div>
      <div id="admin-analytics" class="admin-content hidden">
        <canvas id="analyticsChart" width="400" height="200" class="bg-white/50 rounded-xl p-2"></canvas>
        <p class="text-gray-500 mt-2">*daily active listens (mock)</p>
      </div>
    </section>

    <!-- ############  UPLOAD PAGE  ############ -->
    <section id="view-upload" class="view hidden max-w-2xl mx-auto">
      <div class="glass-card p-8 rounded-2xl">
        <h2 class="text-2xl font-bold mb-6"><i class="fas fa-cloud-upload-alt mr-2 text-blue-500"></i>Upload new audiobook</h2>
        <form onsubmit="handleUpload(event)">
          <div class="grid gap-4">
            <input type="text" id="upload-title" placeholder="Title" class="p-3 border rounded-xl" required>
            <input type="text" id="upload-author" placeholder="Author" class="p-3 border rounded-xl" required>
            <select id="upload-genre" class="p-3 border rounded-xl"><option>Fiction</option><option>Non‚Äëfiction</option><option>Science</option><option>Biography</option></select>
            <textarea id="upload-desc" placeholder="Description" rows="3" class="p-3 border rounded-xl"></textarea>
            <div><label class="block text-gray-600 mb-1">Cover image (optional)</label><input type="file" id="upload-cover" accept="image/*"></div>
            <div><label class="block text-gray-600 mb-1">Audio file (MP3 mock)</label><input type="file" id="upload-audio" accept=".mp3,.m4a,audio/*" required></div>
            <div><label class="block text-gray-600 mb-1">Privacy</label><select id="upload-privacy" class="p-3 border rounded-xl"><option value="public">Public</option><option value="private">Private</option></select></div>
            <button type="submit" class="bg-blue-600 text-white py-3 rounded-xl text-lg"><i class="fas fa-upload mr-2"></i>Publish audiobook</button>
          </div>
        </form>
        <div id="upload-progress" class="mt-4 hidden"><progress value="0" max="100" class="w-full"></progress><span class="text-sm">0%</span></div>
      </div>
    </section>

    <!-- ############  PLAYER VIEW  ############ -->
    <section id="view-player" class="view hidden max-w-4xl mx-auto">
      <div class="glass-card p-8 rounded-3xl text-center">
        <img id="player-cover" src="https://via.placeholder.com/300x300?text=Cover" class="w-64 h-64 mx-auto rounded-2xl shadow-xl object-cover">
        <h2 id="player-title" class="text-3xl font-bold mt-4">Audiobook title</h2>
        <p id="player-author" class="text-gray-500">by Author</p>
        <p id="player-desc" class="text-gray-600 mt-2 max-w-lg mx-auto">Description.</p>
        <!-- actual audio sample (short) -->
        <audio id="audioPlayer" controls class="w-full mt-6 rounded-full" src="https://www2.cs.uic.edu/~i101/SoundFiles/ImperialMarch60.wav"></audio>
        <div class="flex gap-4 justify-center mt-6">
          <button id="download-btn" class="bg-blue-100 text-blue-800 px-6 py-2 rounded-full"><i class="fas fa-download mr-2"></i>Download</button>
          <button id="favorite-btn" class="bg-pink-100 text-pink-800 px-6 py-2 rounded-full"><i class="fas fa-heart mr-2"></i>Favorite</button>
        </div>
        <p class="text-xs text-gray-400 mt-4">*using mock audio (Imperial March sample)</p>
      </div>
    </section>

    <!-- ############  FORGOT PASSWORD  ############ -->
    <section id="view-forgot-password" class="view hidden max-w-md mx-auto">
      <div class="glass-card p-8 rounded-2xl"><h2 class="text-2xl font-bold mb-4">Reset password</h2><form onsubmit="handleForgot(event)"><input type="email" placeholder="Your email" class="w-full p-3 border rounded-xl mb-4" required><button class="w-full bg-gray-700 text-white py-3 rounded-xl">Send reset link</button></form><p class="text-center mt-4"><button onclick="navigate('login')" class="text-blue-600">‚Üê back</button></p></div>
    </section>
  </main>

  <footer class="text-center text-gray-500 text-sm py-6 mt-12 border-t">¬© 2025 Audiobook Hub ‚Äî fully functional demo ¬∑ enjoy!</footer>

  <!-- ========== MEGA JAVASCRIPT (fully functional) ========== -->
  <script>
    (function() {
      // ---------- MOCK DATA & PERSISTENCE ----------
      let mockUser = JSON.parse(localStorage.getItem('audiobookUser')) || null; // { username, email, role }
      // global audiobooks store
      let audiobooks = JSON.parse(localStorage.getItem('audiobooks')) || [
        { id: 'b1', title: 'The Hidden Library', author: 'A. Writer', genre: 'Fiction', cover: '', privacy: 'public', userId: 'u1', username: 'demo', listens: 120, downloads: 34, description: 'A mysterious journey through forgotten books.' },
        { id: 'b2', title: 'Cosmic Wanderer', author: 'S. Explorer', genre: 'Science', privacy: 'public', userId: 'u2', username: 'alice', listens: 89, downloads: 12, description: 'Exploring the universe, one star at a time.' },
        { id: 'b3', title: 'Becoming fearless', author: 'M. Mentor', genre: 'Biography', privacy: 'public', userId: 'u1', username: 'demo', listens: 45, downloads: 8, description: 'Stories of resilience.' }
      ];
      let listeningHistory = JSON.parse(localStorage.getItem('history')) || []; // store book ids with timestamp
      let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

      // ---------- HELPER: save all to localStorage ----------
      function saveAll() {
        localStorage.setItem('audiobooks', JSON.stringify(audiobooks));
        localStorage.setItem('history', JSON.stringify(listeningHistory));
        localStorage.setItem('favorites', JSON.stringify(favorites));
        if (mockUser) localStorage.setItem('audiobookUser', JSON.stringify(mockUser));
        else localStorage.removeItem('audiobookUser');
      }

      // ---------- ROUTER ----------
      window.navigate = function(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        const target = document.getElementById('view-'+viewId);
        if (!target) return;
        target.classList.remove('hidden');
        window.location.hash = viewId;
        renderNav();
        // special loading
        if (viewId === 'dashboard' && mockUser) loadDashboard();
        if (viewId === 'admin-dashboard' && mockUser?.role === 'admin') loadAdminDashboard();
        if (viewId === 'player') populatePlayerFromFirstBook(); // fallback
      };

      // ---------- NAVIGATION BAR ----------
      function renderNav() {
        const nav = document.getElementById('nav-links');
        if (!nav) return;
        const isLogged = !!mockUser;
        const isAdmin = mockUser?.role === 'admin';
        let html = '';
        if (!isLogged) {
          html = `<button onclick="navigate('home')" class="nav-link px-3 py-2 hover:text-blue-600">Home</button>
                  <button onclick="navigate('login')" class="nav-link px-3 py-2 hover:text-blue-600">Login</button>
                  <button onclick="navigate('register')" class="nav-link px-3 py-2 hover:text-blue-600">Register</button>
                  <button onclick="navigate('admin-login')" class="nav-link px-3 py-2 hover:text-purple-600">Admin</button>`;
        } else {
          if (isAdmin) {
            html = `<button onclick="navigate('admin-dashboard')" class="nav-link px-3 py-2 hover:text-purple-600">Dashboard</button>
                    <button onclick="navigate('upload')" class="nav-link px-3 py-2 hover:text-blue-600">Upload</button>
                    <button onclick="navigate('player')" class="nav-link px-3 py-2 hover:text-blue-600">Player</button>
                    <button onclick="logout()" class="nav-link px-3 py-2 text-red-600">Logout</button>`;
          } else {
            html = `<button onclick="navigate('dashboard')" class="nav-link px-3 py-2 hover:text-blue-600">Dashboard</button>
                    <button onclick="navigate('upload')" class="nav-link px-3 py-2 hover:text-blue-600">Upload</button>
                    <button onclick="navigate('player')" class="nav-link px-3 py-2 hover:text-blue-600">Player</button>
                    <button onclick="logout()" class="nav-link px-3 py-2 text-red-600">Logout</button>`;
          }
        }
        nav.innerHTML = html;
      }

      // ---------- AUTH ----------
      window.handleLogin = function(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        mockUser = { username: email.split('@')[0] || 'user', email, role: 'user' };
        saveAll();
        renderNav();
        navigate('dashboard');
      };
      window.handleAdminLogin = function(e) {
        e.preventDefault();
        mockUser = { username: 'admin', email: document.getElementById('admin-email').value, role: 'admin' };
        saveAll();
        renderNav();
        navigate('admin-dashboard');
      };
      window.handleRegister = function(e) {
        e.preventDefault();
        alert('Mock registration successful! Please login.');
        navigate('login');
      };
      window.handleAdminRegister = function(e) {
        e.preventDefault();
        alert('Admin request sent (mock).');
        navigate('admin-login');
      };
      window.logout = function() {
        mockUser = null;
        saveAll();
        renderNav();
        navigate('home');
      };
      window.handleForgot = function(e) {
        e.preventDefault();
        alert('Password reset email sent (mock).');
        navigate('login');
      };

      // ---------- DASHBOARD LOGIC ----------
      function loadDashboard() {
        if (!mockUser) return;
        document.getElementById('dashboard-username').innerText = mockUser.username;
        // my uploads
        const myBooks = audiobooks.filter(b => b.username === mockUser.username);
        const container = document.getElementById('my-uploads-list');
        container.innerHTML = myBooks.length ? myBooks.map(b => `
          <div class="glass-card p-4 rounded-xl audio-card cursor-pointer" onclick="playBook('${b.id}')">
            <div><p class="font-semibold">${b.title}</p><p class="text-sm text-gray-500">${b.author}</p></div>
            <div class="flex justify-between text-xs mt-2"><span>‚ù§Ô∏è ${b.listens || 0}</span><span>‚¨áÔ∏è ${b.downloads || 0}</span></div>
          </div>`).join('') : '<p class="text-gray-400">No uploads yet. Click "Upload new"</p>';

        // history (show titles)
        const historyEl = document.getElementById('history-list');
        const historyItems = listeningHistory.slice(-5).reverse().map(bookId => {
          const book = audiobooks.find(b => b.id === bookId);
          return book ? `<li class="border-b pb-1">‚ñ∂Ô∏è ${book.title} by ${book.author}</li>` : null;
        }).filter(Boolean);
        historyEl.innerHTML = historyItems.length ? historyItems.join('') : '<li class="text-gray-400">No listening history.</li>';

        // favorites
        const favEl = document.getElementById('favorites-list');
        const favItems = favorites.map(bookId => {
          const book = audiobooks.find(b => b.id === bookId);
          return book ? `<li class="border-b pb-1">‚ù§Ô∏è ${book.title} ‚Äî <button onclick="removeFavorite('${book.id}')" class="text-red-400 text-sm">remove</button></li>` : null;
        }).filter(Boolean);
        favEl.innerHTML = favItems.length ? favItems.join('') : '<li class="text-gray-400">No favorites yet.</li>';

        // profile
        document.getElementById('profile-email').value = mockUser.email;
        document.getElementById('profile-username').value = mockUser.username;
      }

      // remove from fav
      window.removeFavorite = function(bookId) {
        favorites = favorites.filter(id => id !== bookId);
        saveAll();
        loadDashboard();
      };

      // play a book (add to history)
      window.playBook = function(bookId) {
        const book = audiobooks.find(b => b.id === bookId);
        if (book) {
          // add to history (avoid dupes?)
          if (!listeningHistory.includes(bookId)) listeningHistory.push(bookId);
          else { // move to end
            listeningHistory = listeningHistory.filter(id => id !== bookId);
            listeningHistory.push(bookId);
          }
          book.listens = (book.listens || 0) + 1;
          saveAll();
          // populate player
          document.getElementById('player-title').innerText = book.title;
          document.getElementById('player-author').innerText = `by ${book.author}`;
          document.getElementById('player-desc').innerText = book.description || 'No description.';
          document.getElementById('player-cover').src = book.cover || 'https://via.placeholder.com/300x300?text=Cover';
          // set audio (use a sample)
          const audio = document.getElementById('audioPlayer');
          audio.src = 'https://www2.cs.uic.edu/~i101/SoundFiles/ImperialMarch60.wav'; // mock
          audio.load();
          // attach download button
          document.getElementById('download-btn').onclick = () => {
            book.downloads = (book.downloads || 0) + 1;
            saveAll();
            alert(`Downloading ${book.title} (mock file)`);
          };
          document.getElementById('favorite-btn').onclick = () => {
            if (!favorites.includes(bookId)) { favorites.push(bookId); alert('Added to favorites'); }
            else alert('Already in favorites');
            saveAll();
          };
          navigate('player');
        }
      };

      function populatePlayerFromFirstBook() {
        if (audiobooks.length) playBook(audiobooks[0].id);
      }

      // dashboard tabs (event delegation)
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('dashboard-tab')) {
          document.querySelectorAll('.dashboard-tab').forEach(t => t.classList.remove('tab-active', 'text-blue-600'));
          e.target.classList.add('tab-active', 'text-blue-600');
          document.querySelectorAll('.dashboard-tab-content').forEach(c => c.classList.add('hidden'));
          document.getElementById('dashboard-'+e.target.dataset.dtab).classList.remove('hidden');
        }
        // admin tabs
        if (e.target.classList.contains('admin-tab')) {
          document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('tab-active'));
          e.target.classList.add('tab-active');
          document.querySelectorAll('.admin-content').forEach(c => c.classList.add('hidden'));
          document.getElementById('admin-'+e.target.dataset.admin).classList.remove('hidden');
        }
      });

      // ---------- ADMIN DASHBOARD ----------
      window.loadAdminDashboard = function() {
        const users = [...new Set(audiobooks.map(b => b.username)), 'admin']; // crude mock
        document.getElementById('stats-users').innerText = users.length;
        document.getElementById('stats-books').innerText = audiobooks.length;
        const totalListens = audiobooks.reduce((acc, b) => acc + (b.listens || 0), 0);
        document.getElementById('stats-listens').innerText = totalListens;

        // mock users list
        const userRows = users.map((u, i) => `<tr><td>${i+1}</td><td>${u}</td><td>${u}@mail.com</td><td>${u==='admin'?'admin':'user'}</td><td><button class="text-red-500" onclick="alert('suspend mock')">suspend</button></td></tr>`).join('');
        document.getElementById('admin-users-list').innerHTML = userRows;

        const bookRows = audiobooks.map(b => `<tr><td>${b.title}</td><td>${b.author}</td><td>${b.username}</td><td><button class="text-red-500" onclick="deleteBook('${b.id}')">delete</button></td></tr>`).join('');
        document.getElementById('admin-books-list').innerHTML = bookRows;

        // chart
        const ctx = document.getElementById('analyticsChart')?.getContext('2d');
        if (ctx) {
          if (window.chartInstance) window.chartInstance.destroy();
          window.chartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'], datasets: [{ label: 'listens', data: [12, 19, 8, 15, 22, 18, 27] }] }
          });
        }
      };

      window.deleteBook = function(bookId) {
        if (confirm('Delete audiobook?')) {
          audiobooks = audiobooks.filter(b => b.id !== bookId);
          saveAll();
          loadAdminDashboard();
        }
      };

      // ---------- UPLOAD HANDLER ----------
      window.handleUpload = function(e) {
        e.preventDefault();
        if (!mockUser) { alert('Login first'); navigate('login'); return; }
        const title = document.getElementById('upload-title').value;
        const author = document.getElementById('upload-author').value;
        const genre = document.getElementById('upload-genre').value;
        const desc = document.getElementById('upload-desc').value;
        const privacy = document.getElementById('upload-privacy').value;
        const newBook = {
          id: 'b' + Date.now(),
          title, author, genre,
          description: desc,
          privacy,
          username: mockUser.username,
          userId: mockUser.email,
          listens: 0, downloads: 0,
          cover: ''
        };
        audiobooks.push(newBook);
        saveAll();
        alert('Audiobook uploaded successfully!');
        navigate('dashboard');
      };

      // ---------- PROFILE UPDATE ----------
      window.updateProfile = function(e) {
        e.preventDefault();
        const newEmail = document.getElementById('profile-email').value;
        const newUsername = document.getElementById('profile-username').value;
        if (mockUser) {
          mockUser.email = newEmail;
          mockUser.username = newUsername;
          saveAll();
          alert('Profile updated');
          loadDashboard();
        }
      };

      // ---------- INIT & ROUTING ----------
      function init() {
        renderNav();
        // hash change
        const hash = window.location.hash.substring(1) || 'home';
        const valid = ['home','login','register','admin-login','admin-register','dashboard','admin-dashboard','upload','player','forgot-password'];
        if (valid.includes(hash)) {
          if ((hash === 'dashboard' || hash === 'upload') && !mockUser) { alert('Please login'); navigate('login'); }
          else if (hash === 'admin-dashboard' && mockUser?.role !== 'admin') { alert('Admin only'); navigate('home'); }
          else navigate(hash);
        } else navigate('home');
      }

      window.addEventListener('hashchange', init);
      init();
    })();
  </script>
  <!-- tiny style to make tabs visible -->
  <style>.tab-active { border-bottom: 3px solid #3b82f6; }</style>
</body>
</html>